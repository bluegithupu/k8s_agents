# K8s Agent 系统设计文档

## 1. 系统概述

### 1.1 设计目标

K8s Agent 旨在构建一个智能化的 Kubernetes 问题排查助手，能够根据用户的自然语言描述，自动规划并执行查询命令，帮助用户快速定位和解决 Kubernetes 集群中的问题。

### 1.2 核心价值

- **降低技术门槛**：使不熟悉 Kubernetes 的用户也能快速排查问题
- **提高效率**：减少手动执行命令和分析日志的时间
- **标准化处理**：提供一致的问题排查流程和最佳实践
- **知识积累**：沉淀问题排查经验，不断优化解决方案

## 2. 系统架构

### 2.1 整体架构

系统采用模块化设计，主要包含以下核心组件：

```
+---------------------+
|     用户界面层      |
+---------------------+
          |
+---------------------+
|     核心引擎层      |
+---------------------+
          |
+---------------------+
|     工具集成层      |
+---------------------+
          |
+---------------------+
|     执行环境层      |
+---------------------+
```

### 2.2 组件说明

#### 2.2.1 用户界面层

- **命令行界面 (CLI)**：提供简洁的命令行交互方式
- **Web 界面**：可选组件，提供图形化的操作界面
- **API 接口**：允许与其他系统集成

#### 2.2.2 核心引擎层

- **自然语言理解模块**：解析用户输入的问题描述
- **任务规划模块**：根据问题生成查询计划
- **命令生成模块**：将查询计划转化为具体的 kubectl 命令
- **结果分析模块**：分析命令执行结果，提取关键信息
- **问题诊断模块**：基于分析结果给出问题诊断和解决方案

#### 2.2.3 工具集成层

- **K8s API 客户端**：与 Kubernetes 集群交互
- **知识库连接器**：连接官方文档和最佳实践
- **搜索引擎连接器**：获取外部信息

#### 2.2.4 执行环境层

- **命令执行环境**：安全地执行 kubectl 等命令
- **状态管理**：维护会话状态和执行历史
- **权限控制**：管理对集群的访问权限

## 3. 核心功能模块

### 3.1 自然语言理解模块

#### 3.1.1 功能描述

将用户的自然语言问题转化为结构化的查询意图和参数。

#### 3.1.2 技术实现

- 使用 OpenAI API 进行自然语言处理
- 构建特定领域的 K8s 问题模型
- 提取关键实体（如命名空间、Pod 名称、服务名等）

### 3.2 任务规划模块

#### 3.2.1 功能描述

根据理解的问题，生成一系列查询步骤，形成排查计划。

#### 3.2.2 技术实现

- 基于 LLM 的任务分解和规划
- 问题类型识别和对应的排查流程模板
- 动态调整计划的能力

### 3.3 命令生成模块

#### 3.3.1 功能描述

将抽象的查询步骤转换为具体的 kubectl 命令或其他操作。

#### 3.3.2 技术实现

- 命令模板库
- 参数填充和验证
- 命令优化和安全检查

### 3.4 结果分析模块

#### 3.4.1 功能描述

解析命令执行结果，提取关键信息，为下一步决策提供依据。

#### 3.4.2 技术实现

- 结构化数据解析（JSON/YAML）
- 日志分析和关键信息提取
- 错误模式识别

### 3.5 问题诊断模块

#### 3.5.1 功能描述

基于收集的信息，诊断问题根因，并提供解决方案。

#### 3.5.2 技术实现

- 基于 LLM 的推理和诊断
- 常见问题知识库
- 解决方案生成和验证

## 4. 技术选型

### 4.1 编程语言和框架

- **主要语言**：Python
- **Web 框架**：FastAPI（如需 Web 界面）
- **CLI 框架**：Click 或 Typer

### 4.2 AI 和 NLP

- **LLM**：OpenAI GPT 模型
- **向量数据库**：可选 Pinecone 或 Milvus（用于知识检索）

### 4.3 外部 API

- **搜索 API**：Tavily Search API
- **K8s API**：官方 Python 客户端

### 4.4 存储

- **会话状态**：Redis 或本地文件存储
- **历史记录**：SQLite 或 PostgreSQL

## 5. 数据流设计

### 5.1 主要数据流程

```
用户输入 → 自然语言理解 → 任务规划 → 命令生成 → 命令执行 → 结果分析 → 问题诊断 → 用户反馈
```

### 5.2 数据模型

#### 5.2.1 用户查询

```python
class UserQuery:
    query_id: str
    raw_text: str
    timestamp: datetime
    context: dict  # 包含集群信息等上下文
```

#### 5.2.2 查询计划

```python
class QueryPlan:
    plan_id: str
    query_id: str
    steps: List[QueryStep]
    status: str  # 进行中、完成、失败
```

#### 5.2.3 查询步骤

```python
class QueryStep:
    step_id: str
    plan_id: str
    description: str
    command: str
    result: str
    status: str
    next_steps: List[str]  # 可能的下一步
```

#### 5.2.4 诊断结果

```python
class Diagnosis:
    diagnosis_id: str
    query_id: str
    problem_description: str
    root_cause: str
    solution: str
    confidence: float
```

## 6. 接口设计

### 6.1 CLI 接口

```
k8s-agent query "我的 nginx pod 无法启动"
k8s-agent explain  # 解释上一步执行的命令
k8s-agent continue  # 继续执行下一步
k8s-agent history  # 显示历史查询
```

### 6.2 API 接口

#### 6.2.1 创建查询

```
POST /api/queries
Content-Type: application/json

{
    "text": "我的 nginx pod 无法启动",
    "context": {
        "namespace": "default",
        "cluster": "production"
    }
}
```

#### 6.2.2 获取查询状态

```
GET /api/queries/{query_id}
```

#### 6.2.3 执行下一步

```
POST /api/queries/{query_id}/next
```

## 7. 安全设计

### 7.1 权限控制

- 基于 Kubernetes RBAC 的权限模型
- 最小权限原则，根据需要授予权限
- 支持只读模式，防止意外修改

### 7.2 命令安全

- 命令白名单机制
- 危险操作确认机制
- 命令执行审计日志

### 7.3 数据安全

- 敏感信息过滤
- 本地处理，减少数据传输
- API 密钥安全存储

## 8. 部署方案

### 8.1 本地部署

- Python 包安装
- 依赖管理
- 配置文件设置

### 8.2 容器化部署

- Docker 镜像构建
- Kubernetes 部署清单
- Helm Chart（可选）

### 8.3 云服务集成

- 支持主流云服务商的 Kubernetes 服务
- 云服务认证集成

## 9. 扩展性设计

### 9.1 插件系统

- 自定义命令插件
- 自定义分析规则
- 第三方工具集成

### 9.2 多集群支持

- 集群配置管理
- 跨集群问题排查

### 9.3 知识库扩展

- 用户反馈学习
- 问题解决方案积累

## 10. 开发路线图

### 10.1 第一阶段：核心功能

- 基本的自然语言理解
- 简单的命令生成和执行
- 基础问题诊断能力

### 10.2 第二阶段：增强功能

- 复杂查询支持
- Web 界面
- 知识库集成

### 10.3 第三阶段：高级特性

- 多集群支持
- 插件系统
- 自动修复建议

## 11. 总结

K8s Agent 系统通过结合 LLM 技术与 Kubernetes 专业知识，提供了一个智能化的问题排查助手。系统设计注重模块化、安全性和可扩展性，能够满足不同用户的需求，并随着使用不断优化和进化。

通过实现这一系统，我们期望能够显著降低 Kubernetes 运维的技术门槛，提高问题排查和解决的效率，为用户提供更好的 Kubernetes 使用体验。